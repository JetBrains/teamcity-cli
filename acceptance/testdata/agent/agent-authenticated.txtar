# Agent commands requiring authentication.
[!has_token] skip 'requires authentication token'

# Start a build to get a cloud agent into the queue early
exec teamcity run start Sandbox_Test --json --no-input
extract '"id":\s*(\d+)' BUILD_ID

# Run list tests while cloud agent spins up
exec teamcity agent list --limit 1 --json --no-input
stdout '"id"'
stdout '"name"'
! stderr 'Error'

exec teamcity agent list --pool Default --no-input
stdout 'ID'
stdout 'NAME'
! stderr 'Error'

exec teamcity agent list --limit 1 --json=id,name,connected --no-input
stdout '"id"'
stdout '"name"'
! stderr 'Error'

! exec teamcity agent view 999999999 --no-input
stderr '.'

# Wait for any connected agent (polls up to 120s)
wait_for_agent AGENT_ID

# Test agent exec first (while build is still running and agent is connected)
exec teamcity agent exec $AGENT_ID 'echo hello-from-agent' --no-input
stdout 'hello-from-agent'
! stderr 'Error'

# Test agent view
exec teamcity agent view $AGENT_ID --no-input
stdout 'ID:'
stdout 'Connected:'
! stderr 'Error'

exec teamcity agent view $AGENT_ID --json --no-input
stdout '"name"'
! stderr 'Error'

# Test agent jobs
exec teamcity agent jobs $AGENT_ID --no-input
stdout '(Compatible|Incompatible|Jobs)'
! stderr 'Error'

# Test agent list shows the agent
exec teamcity agent list --no-input
stdout 'ID'
stdout 'NAME'
! stderr 'Error'

# Cleanup: cancel the build
exec teamcity run cancel $BUILD_ID --force --no-input
